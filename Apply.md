# ğŸš€ Apply å‡½æ•°ä¸é—­åŒ…ç»“åˆæœºåˆ¶è¯¦è§£

æœ¬æ–‡æ¡£æ·±å…¥åˆ†æ Scheme è§£é‡Šå™¨ä¸­ `Apply` å‡½æ•°ä¸é—­åŒ…ï¼ˆClosureï¼‰çš„ç»“åˆæœºåˆ¶ï¼Œå±•ç¤ºå‡½æ•°è°ƒç”¨çš„å®Œæ•´æ‰§è¡Œè¿‡ç¨‹ã€‚

## ğŸ“‹ Apply æ ¸å¿ƒæ¦‚å¿µ

### Apply ç»“æ„å®šä¹‰

```cpp
struct Apply : ExprBase {
    Expr rator;                    ///< å‡½æ•°è¡¨è¾¾å¼ï¼ˆæ“ä½œç¬¦ï¼‰
    std::vector<Expr> rand;        ///< å‚æ•°è¡¨è¾¾å¼åˆ—è¡¨ï¼ˆæ“ä½œæ•°ï¼‰
    Apply(const Expr &, const std::vector<Expr> &);
    virtual Value eval(Assoc &) override;
};
```

`Apply` è¡¨ç¤ºå‡½æ•°è°ƒç”¨è¡¨è¾¾å¼ï¼Œå¯¹åº” Scheme ä¸­çš„ `(function arg1 arg2 ...)` è¯­æ³•ï¼š
- **`rator`**ï¼ˆoperatorï¼‰ï¼šè¦è°ƒç”¨çš„å‡½æ•°è¡¨è¾¾å¼
- **`rand`**ï¼ˆoperandsï¼‰ï¼šä¼ é€’ç»™å‡½æ•°çš„å‚æ•°è¡¨è¾¾å¼åˆ—è¡¨

## ğŸ”§ Apply::eval å®Œæ•´æ‰§è¡Œæµç¨‹

### æ ¸å¿ƒä»£ç åˆ†æ

```cpp
Value Apply::eval(Assoc &e) {
    // ç¬¬ä¸€é˜¶æ®µï¼šæ±‚å€¼å‡½æ•°è¡¨è¾¾å¼
    Value mid_fun = rator->eval(e);
    if (mid_fun->v_type != V_PROC) {
        throw RuntimeError("Attempt to apply a non-procedure");
    }

    Procedure* clos_ptr = dynamic_cast<Procedure*>(mid_fun.get());
    
    // ç¬¬äºŒé˜¶æ®µï¼šæ±‚å€¼å‚æ•°è¡¨è¾¾å¼
    std::vector<Value> args;
    for (int i = 0; i < rand.size(); i++) {
        args.push_back(rand[i]->eval(e));
    }

    // ç¬¬ä¸‰é˜¶æ®µï¼šå‚æ•°æ•°é‡éªŒè¯
    if (args.size() != clos_ptr->parameters.size()) {
        throw RuntimeError("Wrong number of arguments");
    }

    // ç¬¬å››é˜¶æ®µï¼šæ„å»ºæ‰§è¡Œç¯å¢ƒ
    Assoc param_env = clos_ptr->env;
    for (int i = 0; i < clos_ptr->parameters.size(); i++) {
        param_env = extend(clos_ptr->parameters[i], args[i], param_env);
    }

    // ç¬¬äº”é˜¶æ®µï¼šæ‰§è¡Œå‡½æ•°ä½“
    return clos_ptr->e->eval(param_env);
}
```

## ğŸ” äº”é˜¶æ®µæ‰§è¡Œæœºåˆ¶è¯¦è§£

### é˜¶æ®µ 1ï¼šå‡½æ•°è¡¨è¾¾å¼æ±‚å€¼

```cpp
Value mid_fun = rator->eval(e);
if (mid_fun->v_type != V_PROC) {
    throw RuntimeError("Attempt to apply a non-procedure");
}
```

**åŠŸèƒ½**ï¼šå°†å‡½æ•°è¡¨è¾¾å¼è½¬æ¢ä¸ºå¯è°ƒç”¨çš„ `Procedure` å¯¹è±¡

**ç¤ºä¾‹åœºæ™¯**ï¼š
```scheme
;; åœºæ™¯1ï¼šç›´æ¥å‡½æ•°è°ƒç”¨
((lambda (x) (* x x)) 5)
;; rator = Lambdaè¡¨è¾¾å¼ï¼Œæ±‚å€¼åå¾—åˆ°Procedureå¯¹è±¡

;; åœºæ™¯2ï¼šå˜é‡å¼•ç”¨å‡½æ•°  
(define square (lambda (x) (* x x)))
(square 5)
;; rator = Var("square")ï¼Œæ±‚å€¼åä»ç¯å¢ƒä¸­è·å–Procedureå¯¹è±¡

;; åœºæ™¯3ï¼šé«˜é˜¶å‡½æ•°è¿”å›
(define (make-multiplier n) (lambda (x) (* x n)))
((make-multiplier 3) 4)
;; rator = Applyè¡¨è¾¾å¼ï¼Œæ±‚å€¼åå¾—åˆ°æ–°çš„Procedureå¯¹è±¡

;; åœºæ™¯4ï¼šåŸè¯­å‡½æ•°
(+ 1 2 3)
;; rator = Var("+")ï¼Œæ±‚å€¼æ—¶åŠ¨æ€åˆ›å»ºProcedureå¯¹è±¡åŒ…è£…åŸè¯­
```

**å¤„ç†é€»è¾‘**ï¼š
- **Lambdaè¡¨è¾¾å¼**ï¼šç›´æ¥åˆ›å»ºé—­åŒ…å¯¹è±¡
- **å˜é‡å¼•ç”¨**ï¼šä»ç¯å¢ƒä¸­æŸ¥æ‰¾å·²å®šä¹‰çš„å‡½æ•°
- **åŸè¯­å‡½æ•°**ï¼šåŠ¨æ€åŒ…è£…ä¸º `Procedure` å¯¹è±¡
- **å¤åˆè¡¨è¾¾å¼**ï¼šé€’å½’æ±‚å€¼ç›´åˆ°å¾—åˆ°å‡½æ•°å¯¹è±¡

### é˜¶æ®µ 2ï¼šå‚æ•°è¡¨è¾¾å¼æ±‚å€¼

```cpp
std::vector<Value> args;
for (int i = 0; i < rand.size(); i++) {
    args.push_back(rand[i]->eval(e));
}
```

**åŠŸèƒ½**ï¼šå°†æ‰€æœ‰å‚æ•°è¡¨è¾¾å¼è½¬æ¢ä¸ºå€¼å¯¹è±¡

**æ±‚å€¼ç‰¹ç‚¹**ï¼š
- **ä»å·¦åˆ°å³**ï¼šæŒ‰å‚æ•°åˆ—è¡¨é¡ºåºä¾æ¬¡æ±‚å€¼
- **å½“å‰ç¯å¢ƒ**ï¼šåœ¨è°ƒç”¨ç‚¹çš„ç¯å¢ƒ `e` ä¸­æ±‚å€¼å‚æ•°
- **å®Œå…¨æ±‚å€¼**ï¼šæ‰€æœ‰å‚æ•°åœ¨å‡½æ•°è°ƒç”¨å‰å®Œå…¨æ±‚å€¼ï¼ˆä¸¥æ ¼æ±‚å€¼ç­–ç•¥ï¼‰

**ç¤ºä¾‹åˆ†æ**ï¼š
```scheme
;; ç¤ºä¾‹ï¼š(square (+ 2 3))
;; å‚æ•°æ±‚å€¼è¿‡ç¨‹ï¼š
;; 1. rand[0] = Plus(Fixnum(2), Fixnum(3))
;; 2. args[0] = Plus::eval(e) = IntegerV(5)
;; 3. ç„¶åè°ƒç”¨ square å‡½æ•°ï¼Œä¼ å…¥ 5

;; å¤æ‚ç¤ºä¾‹ï¼š((lambda (f x) (f x)) square (+ 1 4))
;; å‚æ•°æ±‚å€¼è¿‡ç¨‹ï¼š
;; 1. args[0] = squareå‡½æ•°å¯¹è±¡
;; 2. args[1] = IntegerV(5)
;; 3. è°ƒç”¨lambdaï¼Œfç»‘å®šåˆ°squareï¼Œxç»‘å®šåˆ°5
```

### é˜¶æ®µ 3ï¼šå‚æ•°æ•°é‡éªŒè¯

```cpp
if (args.size() != clos_ptr->parameters.size()) {
    throw RuntimeError("Wrong number of arguments");
}
```

**åŠŸèƒ½**ï¼šç¡®ä¿å®é™…å‚æ•°ä¸å½¢å¼å‚æ•°æ•°é‡åŒ¹é…

**éªŒè¯é€»è¾‘**ï¼š
- **ç²¾ç¡®åŒ¹é…**ï¼šå‚æ•°æ•°é‡å¿…é¡»å®Œå…¨ç›¸ç­‰
- **é”™è¯¯å¤„ç†**ï¼šä¸åŒ¹é…æ—¶æŠ›å‡ºè¿è¡Œæ—¶é”™è¯¯
- **ç±»å‹å®‰å…¨**ï¼šé˜²æ­¢è®¿é—®ä¸å­˜åœ¨çš„å‚æ•°

**é”™è¯¯ç¤ºä¾‹**ï¼š
```scheme
;; é”™è¯¯ï¼šå‚æ•°è¿‡å¤š
((lambda (x) x) 1 2 3)  ;; RuntimeError: Wrong number of arguments

;; é”™è¯¯ï¼šå‚æ•°è¿‡å°‘  
((lambda (x y) (+ x y)) 1)  ;; RuntimeError: Wrong number of arguments

;; æ­£ç¡®ï¼šå‚æ•°åŒ¹é…
((lambda (x y) (+ x y)) 1 2)  ;; æ­£å¸¸æ‰§è¡Œ
```

### é˜¶æ®µ 4ï¼šæ„å»ºæ‰§è¡Œç¯å¢ƒï¼ˆå…³é”®é—­åŒ…æœºåˆ¶ï¼‰

```cpp
Assoc param_env = clos_ptr->env;
for (int i = 0; i < clos_ptr->parameters.size(); i++) {
    param_env = extend(clos_ptr->parameters[i], args[i], param_env);
}
```

**åŠŸèƒ½**ï¼šåœ¨é—­åŒ…ç¯å¢ƒåŸºç¡€ä¸Šæ·»åŠ å‚æ•°ç»‘å®š

**ç¯å¢ƒæ„å»ºç­–ç•¥**ï¼š
1. **åŸºç¡€ç¯å¢ƒ**ï¼šä»é—­åŒ…çš„ `env` å¼€å§‹ï¼ˆå‡½æ•°å®šä¹‰æ—¶çš„ç¯å¢ƒï¼‰
2. **å‚æ•°ç»‘å®š**ï¼šé€ä¸ªæ·»åŠ å‚æ•°ååˆ°å‚æ•°å€¼çš„ç»‘å®š
3. **ç¯å¢ƒæ‰©å±•**ï¼šä½¿ç”¨ `extend` å‡½æ•°åˆ›å»ºæ–°çš„ç¯å¢ƒå±‚

**ç¯å¢ƒå±‚æ¬¡ç»“æ„**ï¼š
```
æ‰§è¡Œç¯å¢ƒå±‚æ¬¡ï¼ˆç”±å†…åˆ°å¤–ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‚æ•°ç»‘å®šå±‚               â”‚ â† extend(param_name, arg_value, closure_env)
â”‚ param1 = arg1           â”‚
â”‚ param2 = arg2           â”‚ 
â”‚ ...                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é—­åŒ…æ•è·ç¯å¢ƒ             â”‚ â† clos_ptr->env (å‡½æ•°å®šä¹‰æ—¶çš„ç¯å¢ƒ)
â”‚ captured_var1 = value1  â”‚
â”‚ captured_var2 = value2  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¤–å±‚ç¯å¢ƒé“¾               â”‚
â”‚ ...                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é˜¶æ®µ 5ï¼šå‡½æ•°ä½“æ‰§è¡Œ

```cpp
return clos_ptr->e->eval(param_env);
```

**åŠŸèƒ½**ï¼šåœ¨æ„å»ºå¥½çš„ç¯å¢ƒä¸­æ‰§è¡Œå‡½æ•°ä½“è¡¨è¾¾å¼

**æ‰§è¡Œç‰¹ç‚¹**ï¼š
- **æ–°ç¯å¢ƒ**ï¼šåœ¨ `param_env` ä¸­æ‰§è¡Œï¼ŒåŒ…å«å‚æ•°ç»‘å®šå’Œé—­åŒ…ç¯å¢ƒ
- **è¡¨è¾¾å¼æ±‚å€¼**ï¼šé€’å½’è°ƒç”¨è¡¨è¾¾å¼æ±‚å€¼ç³»ç»Ÿ
- **è¿”å›å€¼**ï¼šå‡½æ•°ä½“è¡¨è¾¾å¼çš„æ±‚å€¼ç»“æœå³ä¸ºå‡½æ•°è°ƒç”¨ç»“æœ

## ğŸ”— Apply ä¸é—­åŒ…ç»“åˆçš„æ ¸å¿ƒä¼˜åŠ¿

### 1. å®Œæ•´çš„è¯æ³•ä½œç”¨åŸŸæ”¯æŒ

```scheme
;; ç¤ºä¾‹ï¼šåµŒå¥—ä½œç”¨åŸŸ
(define (outer x)
  (define (inner y)
    (+ x y))  ;; å¯ä»¥è®¿é—®å¤–å±‚çš„ x
  inner)

(define add5 (outer 5))
(add5 3)  ;; 8
```

**æ‰§è¡Œåˆ†æ**ï¼š
1. **åˆ›å»º `outer` é—­åŒ…**ï¼šæ•è·å…¨å±€ç¯å¢ƒ
2. **è°ƒç”¨ `(outer 5)`**ï¼š
   - åœ¨é—­åŒ…ç¯å¢ƒåŸºç¡€ä¸Šæ·»åŠ  `x = 5`
   - å®šä¹‰ `inner` æ—¶æ•è·åŒ…å« `x = 5` çš„ç¯å¢ƒ
3. **è°ƒç”¨ `(add5 3)`**ï¼š
   - `add5` æ˜¯ `inner` é—­åŒ…ï¼Œç¯å¢ƒä¸­åŒ…å« `x = 5`
   - æ·»åŠ å‚æ•° `y = 3`
   - æ‰§è¡Œ `(+ x y)` å¾—åˆ° `8`

### 2. åŠ¨æ€å‡½æ•°è°ƒç”¨æ”¯æŒ

```scheme
;; ç¤ºä¾‹ï¼šå‡½æ•°ä½œä¸ºä¸€ç­‰å…¬æ°‘
(define (apply-twice f x)
  (f (f x)))

(define square (lambda (x) (* x x)))
(apply-twice square 2)  ;; 256, å³ ((2^2)^2)
```

**æ‰§è¡Œåˆ†æ**ï¼š
1. **ç¬¬ä¸€æ¬¡Apply**ï¼š`(apply-twice square 2)`
   - `f` ç»‘å®šåˆ° `square` é—­åŒ…
   - `x` ç»‘å®šåˆ° `IntegerV(2)`
2. **ç¬¬äºŒæ¬¡Apply**ï¼šå†…å±‚çš„ `(f x)`
   - è°ƒç”¨ `square(2)` å¾—åˆ° `4`
3. **ç¬¬ä¸‰æ¬¡Apply**ï¼šå¤–å±‚çš„ `f (...)`
   - è°ƒç”¨ `square(4)` å¾—åˆ° `16`

### 3. é«˜é˜¶å‡½æ•°ä¸é—­åŒ…ç”Ÿæˆ

```scheme
;; ç¤ºä¾‹ï¼šé—­åŒ…å·¥å‚
(define (make-counter)
  (define count 0)
  (lambda ()
    (set! count (+ count 1))
    count))

(define counter1 (make-counter))
(define counter2 (make-counter))
(counter1)  ;; 1
(counter1)  ;; 2  
(counter2)  ;; 1
```

**æ‰§è¡Œåˆ†æ**ï¼š
- **æ¯æ¬¡è°ƒç”¨ `make-counter`**ï¼šåˆ›å»ºç‹¬ç«‹çš„ç¯å¢ƒåŒ…å« `count = 0`
- **è¿”å›çš„lambda**ï¼šæ•è·å„è‡ªç‹¬ç«‹çš„ `count` å˜é‡
- **è°ƒç”¨è®¡æ•°å™¨**ï¼šåœ¨å„è‡ªçš„é—­åŒ…ç¯å¢ƒä¸­ä¿®æ”¹ `count`

## ğŸ“Š Apply æ‰§è¡Œæµç¨‹å›¾

```mermaid
graph TD
    A[Apply::eval å¼€å§‹] --> B[æ±‚å€¼å‡½æ•°è¡¨è¾¾å¼ rator]
    B --> C{æ˜¯å¦ä¸º Procedure?}
    C -->|å¦| D[æŠ›å‡º RuntimeError]
    C -->|æ˜¯| E[è·å– Procedure å¯¹è±¡]
    E --> F[æ±‚å€¼æ‰€æœ‰å‚æ•°è¡¨è¾¾å¼]
    F --> G{å‚æ•°æ•°é‡åŒ¹é…?}
    G -->|å¦| H[æŠ›å‡º RuntimeError]
    G -->|æ˜¯| I[æ„å»ºæ‰§è¡Œç¯å¢ƒ]
    I --> J[åŸºç¡€ç¯å¢ƒ = é—­åŒ…ç¯å¢ƒ]
    J --> K[é€ä¸ªæ·»åŠ å‚æ•°ç»‘å®š]
    K --> L[åœ¨æ–°ç¯å¢ƒä¸­æ‰§è¡Œå‡½æ•°ä½“]
    L --> M[è¿”å›æ‰§è¡Œç»“æœ]
    
    style A fill:#e1f5fe
    style M fill:#c8e6c9
    style D fill:#ffcdd2
    style H fill:#ffcdd2
```

## ğŸ¯ å¤æ‚ç¤ºä¾‹åˆ†æ

### ç¤ºä¾‹ 1ï¼šé€’å½’å‡½æ•°è°ƒç”¨

```scheme
(define (factorial n)
  (if (<= n 1)
      1
      (* n (factorial (- n 1)))))

(factorial 4)
```

**è°ƒç”¨æ ˆåˆ†æ**ï¼š
```
Applyæ ˆå±‚æ¬¡ï¼ˆæœ€æ–°è°ƒç”¨åœ¨é¡¶éƒ¨ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ factorial(1): env={n=1}     â”‚ â†’ è¿”å› 1
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  
â”‚ factorial(2): env={n=2}     â”‚ â†’ è¿”å› 2*1=2
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ factorial(3): env={n=3}     â”‚ â†’ è¿”å› 3*2=6  
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ factorial(4): env={n=4}     â”‚ â†’ è¿”å› 4*6=24
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¯æ¬¡Applyæ‰§è¡Œ**ï¼š
1. **å‡½æ•°æ±‚å€¼**ï¼š`factorial` å˜é‡å¼•ç”¨åŒä¸€ä¸ªé—­åŒ…
2. **å‚æ•°æ±‚å€¼**ï¼šé€’å‡çš„æ•°å€¼
3. **ç¯å¢ƒæ„å»º**ï¼šæ¯æ¬¡è°ƒç”¨ç‹¬ç«‹çš„ `n` ç»‘å®š
4. **é€’å½’è°ƒç”¨**ï¼šåœ¨æ¡ä»¶åˆ†æ”¯ä¸­å†æ¬¡è§¦å‘Apply

### ç¤ºä¾‹ 2ï¼šé«˜é˜¶å‡½æ•°ç»„åˆ

```scheme
(define (compose f g)
  (lambda (x) (f (g x))))

(define (add1 x) (+ x 1))
(define (mul2 x) (* x 2))
(define add1-then-mul2 (compose mul2 add1))

(add1-then-mul2 3)  ;; (3+1)*2 = 8
```

**æ‰§è¡Œè¿½è¸ª**ï¼š
1. **åˆ›å»ºcomposeé—­åŒ…**ï¼šæ•è·å…¨å±€ç¯å¢ƒ
2. **è°ƒç”¨compose**ï¼š
   - `f` ç»‘å®šåˆ° `mul2` é—­åŒ…
   - `g` ç»‘å®šåˆ° `add1` é—­åŒ…
   - è¿”å›æ–°é—­åŒ…ï¼Œæ•è·åŒ…å« `f` å’Œ `g` çš„ç¯å¢ƒ
3. **è°ƒç”¨ç»„åˆå‡½æ•°**ï¼š
   - `x` ç»‘å®šåˆ° `3`
   - æ‰§è¡Œ `(g x)`ï¼šè°ƒç”¨ `add1(3)` å¾—åˆ° `4`
   - æ‰§è¡Œ `(f ...)`ï¼šè°ƒç”¨ `mul2(4)` å¾—åˆ° `8`

### ç¤ºä¾‹ 3ï¼šé—­åŒ…çŠ¶æ€ä¿®æ”¹

```scheme
(define (make-account balance)
  (lambda (amount)
    (set! balance (+ balance amount))
    balance))

(define account (make-account 100))
(account 50)   ;; 150
(account -30)  ;; 120
```

**çŠ¶æ€å˜åŒ–è¿½è¸ª**ï¼š
1. **åˆ›å»ºaccounté—­åŒ…**ï¼šç¯å¢ƒåŒ…å« `balance = 100`
2. **ç¬¬ä¸€æ¬¡è°ƒç”¨**ï¼š
   - `amount` ç»‘å®šåˆ° `50`
   - `set!` ä¿®æ”¹é—­åŒ…ç¯å¢ƒä¸­çš„ `balance` ä¸º `150`
   - è¿”å› `150`
3. **ç¬¬äºŒæ¬¡è°ƒç”¨**ï¼š
   - `amount` ç»‘å®šåˆ° `-30`
   - `set!` ä¿®æ”¹å·²å­˜åœ¨çš„ `balance` ä¸º `120`
   - è¿”å› `120`

## ğŸ”§ é”™è¯¯å¤„ç†æœºåˆ¶

### 1. ç±»å‹é”™è¯¯æ£€æµ‹

```cpp
if (mid_fun->v_type != V_PROC) {
    throw RuntimeError("Attempt to apply a non-procedure");
}
```

**è§¦å‘åœºæ™¯**ï¼š
```scheme
(1 2 3)        ;; è¯•å›¾è°ƒç”¨æ•°å­—
("hello" 42)   ;; è¯•å›¾è°ƒç”¨å­—ç¬¦ä¸²  
(#t #f)        ;; è¯•å›¾è°ƒç”¨å¸ƒå°”å€¼
```

### 2. å‚æ•°æ•°é‡éªŒè¯

```cpp
if (args.size() != clos_ptr->parameters.size()) {
    throw RuntimeError("Wrong number of arguments");
}
```

**è§¦å‘åœºæ™¯**ï¼š
```scheme
((lambda (x y) (+ x y)) 1)      ;; å‚æ•°ä¸è¶³
((lambda () 42) 1 2)            ;; å‚æ•°è¿‡å¤š
```

### 3. è¿è¡Œæ—¶é”™è¯¯ä¼ æ’­

å‡½æ•°ä½“æ‰§è¡Œä¸­çš„é”™è¯¯ä¼šè‡ªåŠ¨ä¼ æ’­ï¼š
```scheme
(define (divide x y)
  (/ x y))

(divide 1 0)  ;; RuntimeError: Division by zero
```

## ğŸ’¡ è®¾è®¡æ¨¡å¼ä¸æœ€ä½³å®è·µ

### 1. å‡½æ•°å¼ç¼–ç¨‹æ¨¡å¼

```scheme
;; æ˜ å°„æ¨¡å¼
(define (map f lst)
  (if (null? lst)
      '()
      (cons (f (car lst)) 
            (map f (cdr lst)))))

;; æŠ˜å æ¨¡å¼  
(define (fold f init lst)
  (if (null? lst)
      init
      (fold f (f init (car lst)) (cdr lst))))
```

### 2. å›è°ƒå’Œäº‹ä»¶å¤„ç†

```scheme
;; äº‹ä»¶ç›‘å¬å™¨æ¨¡å¼
(define (on-click handler)
  (lambda (event)
    (handler event)))

;; ä½¿ç”¨å›è°ƒ
(define button-handler
  (on-click (lambda (evt) (display "Button clicked!"))))
```

### 3. åå‡½æ•°åº”ç”¨

```scheme
;; ååº”ç”¨å·¥å…·
(define (partial f . args)
  (lambda more-args
    (apply f (append args more-args))))

;; åˆ›å»ºä¸“ç”¨å‡½æ•°
(define add10 (partial + 10))
(add10 5)  ;; 15
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–è€ƒè™‘

### 1. ç¯å¢ƒæŸ¥æ‰¾ä¼˜åŒ–

**å½“å‰å®ç°**ï¼šO(n) é“¾è¡¨æŸ¥æ‰¾
```cpp
// ç¯å¢ƒé“¾éå†æŸ¥æ‰¾å˜é‡
Value find(const std::string &x, Assoc &env) {
    // çº¿æ€§æŸ¥æ‰¾å®ç°
}
```

**å¯èƒ½ä¼˜åŒ–**ï¼š
- **å“ˆå¸Œè¡¨ç¯å¢ƒ**ï¼šO(1) å˜é‡æŸ¥æ‰¾
- **é™æ€åˆ†æ**ï¼šç¼–è¯‘æ—¶ç¡®å®šå˜é‡ä½ç½®
- **ç¯å¢ƒå‹ç¼©**ï¼šç§»é™¤æœªä½¿ç”¨çš„ç»‘å®š

### 2. é—­åŒ…å…±äº«ä¼˜åŒ–

**å½“å‰å®ç°**ï¼šæ™ºèƒ½æŒ‡é’ˆè‡ªåŠ¨ç®¡ç†
```cpp
std::shared_ptr<ValueBase> ptr;
std::shared_ptr<AssocList> ptr;
```

**ä¼˜åŒ–ç­–ç•¥**ï¼š
- **ç¯å¢ƒå…±äº«**ï¼šç›¸åŒä½œç”¨åŸŸçš„å¤šä¸ªé—­åŒ…å…±äº«ç¯å¢ƒ
- **å»¶è¿Ÿå¤åˆ¶**ï¼šå†™æ—¶å¤åˆ¶ï¼ˆCopy-on-Writeï¼‰æœºåˆ¶
- **åƒåœ¾å›æ”¶**ï¼šå®šæœŸæ¸…ç†æ— ç”¨ç¯å¢ƒé“¾

### 3. è°ƒç”¨æ ˆä¼˜åŒ–

**å°¾é€’å½’ä¼˜åŒ–**ï¼š
```scheme
;; å¯ä¼˜åŒ–ä¸ºå¾ªç¯çš„å°¾é€’å½’
(define (factorial-tail n acc)
  (if (<= n 1) 
      acc
      (factorial-tail (- n 1) (* n acc))))
```

## ğŸ“ˆ æ‰©å±•åŠŸèƒ½æ”¯æŒ

### 1. å¯å˜å‚æ•°å‡½æ•°

```scheme
;; æ”¯æŒrestå‚æ•°ï¼ˆæœªæ¥æ‰©å±•ï¼‰
(define (variadic-func x . rest)
  (cons x rest))
```

### 2. å…³é”®å­—å‚æ•°

```scheme
;; å‘½åå‚æ•°æ”¯æŒï¼ˆæœªæ¥æ‰©å±•ï¼‰
(define (make-point #:x x #:y y)
  (list x y))
```

### 3. é»˜è®¤å‚æ•°

```scheme
;; é»˜è®¤å‚æ•°å€¼ï¼ˆæœªæ¥æ‰©å±•ï¼‰
(define (greet name (greeting "Hello"))
  (string-append greeting ", " name))
```

## ğŸ¯ æ€»ç»“

Apply å‡½æ•°ä¸é—­åŒ…çš„ç»“åˆæ˜¯ Scheme è§£é‡Šå™¨å‡½æ•°è°ƒç”¨æœºåˆ¶çš„æ ¸å¿ƒï¼Œå®ƒå®ç°äº†ï¼š

### âœ… æ ¸å¿ƒåŠŸèƒ½
1. **å®Œæ•´çš„å‡½æ•°è°ƒç”¨è¯­ä¹‰**ï¼šæ”¯æŒä»»æ„å¤æ‚çš„å‡½æ•°è¡¨è¾¾å¼
2. **ä¸¥æ ¼çš„å‚æ•°æ±‚å€¼**ï¼šä¿è¯å‡½æ•°è°ƒç”¨å‰å‚æ•°å®Œå…¨æ±‚å€¼
3. **è¯æ³•ä½œç”¨åŸŸæ”¯æŒ**ï¼šé€šè¿‡é—­åŒ…ç¯å¢ƒå®ç°å˜é‡æ•è·
4. **ç±»å‹å®‰å…¨æ£€æŸ¥**ï¼šè¿è¡Œæ—¶éªŒè¯å‡½æ•°ç±»å‹å’Œå‚æ•°åŒ¹é…
5. **é”™è¯¯å¤„ç†æœºåˆ¶**ï¼šæä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

### âœ… é«˜çº§ç‰¹æ€§
1. **é«˜é˜¶å‡½æ•°æ”¯æŒ**ï¼šå‡½æ•°å¯ä»¥ä½œä¸ºå‚æ•°å’Œè¿”å›å€¼
2. **é€’å½’è°ƒç”¨æ”¯æŒ**ï¼šé€šè¿‡ç¯å¢ƒç‹¬ç«‹æ€§æ”¯æŒæ·±åº¦é€’å½’
3. **çŠ¶æ€å°è£…èƒ½åŠ›**ï¼šé—­åŒ…å¯ä»¥ç»´æŠ¤ç§æœ‰çŠ¶æ€
4. **åŠ¨æ€è°ƒç”¨èƒ½åŠ›**ï¼šè¿è¡Œæ—¶ç¡®å®šè°ƒç”¨ç›®æ ‡

### âœ… è®¾è®¡ä¼˜åŠ¿
1. **ç»Ÿä¸€æŠ½è±¡**ï¼šåŸè¯­å‡½æ•°å’Œç”¨æˆ·å‡½æ•°ä½¿ç”¨ç›¸åŒè°ƒç”¨æœºåˆ¶
2. **ç¯å¢ƒéš”ç¦»**ï¼šæ¯æ¬¡è°ƒç”¨åˆ›å»ºç‹¬ç«‹çš„æ‰§è¡Œç¯å¢ƒ
3. **å†…å­˜å®‰å…¨**ï¼šæ™ºèƒ½æŒ‡é’ˆè‡ªåŠ¨ç®¡ç†å†…å­˜ç”Ÿå‘½å‘¨æœŸ
4. **æ‰©å±•æ€§å¼º**ï¼šæ”¯æŒå„ç§å‡½æ•°å¼ç¼–ç¨‹æ¨¡å¼

è¿™ç§è®¾è®¡ä½¿å¾— Scheme è§£é‡Šå™¨å…·å¤‡äº†ç°ä»£å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€çš„æ ¸å¿ƒèƒ½åŠ›ï¼Œä¸ºå¤æ‚çš„è®¡ç®—æŠ½è±¡æä¾›äº†åšå®çš„åŸºç¡€ã€‚
